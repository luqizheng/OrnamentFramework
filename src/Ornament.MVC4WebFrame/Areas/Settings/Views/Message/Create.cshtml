@using System.Web.UI.WebControls
@using Ornament.Messages
@using Resources
@using Ornament.Web.HtmlExtends
@model Ornament.Messages.Message


@{
    ViewBag.Title = "Create new message";
    Layout = "~/Views/Shared/_appLayout.cshtml";
    var types = ViewData["types"] as IEnumerable<MessageType>;
}
@section pageTitle
{
    <h5>Create new message</h5>
}

<form method="POST" action="@Url.Action("Save")">
    <div class="widget">
        <div class="navbar">
            <div class="navbar-inner">
                <button id="submitButton" class="btn btn-info" type="button">@Basic.Submit</button>
                <a href="@Url.Action("Index")" class="btn">Back</a>
            </div>
        </div>
        <div class="well body">
            <div class="tabbable tabs-left">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#tab7"><i class="fam-layout-content"></i>Basic</a></li>
                    <li class=""><a data-toggle="tab" href="#tab8"><i class="fam-date"></i>Content</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab7" class="tab-pane active">
                        <div class="form-horizontal row-fluid">
                            @Html.BootstrapLabelTextBoxFor(s => s.Subject)
                            <div class="control-group">
                                <label class="control-label">@Html.DisplayNameFor(s => s.Type)</label>
                                <div class="controls">
                                    <select name="Type" class="bulk" id="Type">
                                        @foreach (var type in types ?? (new List<MessageType>()))
                                        {
                                            <option value="@type.Id">@type.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label">User:</label>
                                <div class="controls">
                                    <input type="hidden" name="Users" id="Users" />
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label">Roles:</label>
                                <div class="controls">
                                    <select name="Roles" id="Roles" class="bulk"></select>
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label">UserGroup:</label>
                                <div class="controls">
                                    <select name="UserGroups" id="UserGroups"></select>
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label">Orgs:</label>
                                <div class="controls">
                                    <select name="Orgs" id="Orgs"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab8" class="tab-pane">
                        <div>
                            <div class="control-group">
                                <select id="Language">
                                    <option value="en">英文</option>
                                </select>
                                <a class="btn btn-info" href="#myModal" role="button" data-toggle="modal">@Basic.Add</a>
                                <a class="btn btn-danger">@Basic.Delete</a>

                            </div>
                            <div class="control-group">
                                <textarea name="editor" id="editor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</form>
1231sf
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Input Language</h3>
    </div>
    <div class="modal-body">
        <select id="LanguageName" class="styled">
            <option value="zh-cn">简体中文</option>
            <option value="zh">繁体中文</option>
            <option value="en">英文</option>
        </select>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button class="btn btn-primary" id="saveChanged">Save changes</button>
    </div>
</div>

@section script
{
    <script type="text/javascript">
        var content =@(this.Model != null ? Qi.Web.JsonHelper.ToJson(this.Model.Contents) : "{}")
        seajs.use(['ckeditor/ckeditor.js', "select2", "bootstrap","user"], function () {

            var editor = CKEDITOR.replace('editor');
            editor.on("blur", function () {
                content[$("#Language").val()] = editor.getData();
            });
            $("#Type").select2();
            $("#Users").select2({
                minimumInputLength: 1,
                query: function (query) {
                    $.users.search(query.term, 10, function (data) {
                        var r = [];
                        for (var item in data) {
                            r.push({ id: item.id, text: item.Name + "(" + item.LoginId + ")" });
                        }
                        query.callback(r);
                    });
                }
            });


            $("#Roles").select2();
            $("#UserGroups").select2();
            $("#Orgs").select2();


            $("#Language").select2().change(function () {
                var cont = content[$(this).val()];
                editor.setData(cont ? cont : "");
            }).change().next().click(function () {
                $("#LanguageName").val("");
            }).next().click(function () {
                var langCode = $("#LanguageName").val();
                content[langCode] = "";
            });

            $("#saveChanged").click(function () {
                $("#myModal").modal("hide");
                var $lang = $("#LanguageName");
                var langCode = $lang.val();
                var lang = $lang.find("option:selected").text();
                $lang.find("option:selected").remove();
                $("#Language").append("<option value='" + langCode + "'>" + lang + "<option>");

            });
            $("#submitButton").click(function () {
                //Make sure the editor save to content.
                content[$("#Language").val()] = editor.getData();
                var ary = [];
                for (var key in content) {
                    var v = content[key];
                    ary.push("<input type='hidden' value='" + v + "' name='NewContents[" + key + "]'/>");
                }
                $("form").append(ary.join("")).submit();
            });
        });
    </script>
}
