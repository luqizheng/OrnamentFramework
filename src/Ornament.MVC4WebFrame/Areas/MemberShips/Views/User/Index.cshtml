@using Ornament.MVCWebFrame.Models
@using Ornament.MVCWebFrame.Models.Membership
@using Ornament.MemberShip
@using Ornament.Models.Memberships
@using Ornament.Web
@using Ornament.Web.HtmlExtends;
@using Resources
@model IList<Ornament.MemberShip.User>
@{
    ViewBag.Title = MemberShip.User;
    Layout = "~/Views/Shared/_appLayout.cshtml";
    bool editPermission = OrnamentContext.Current.HasRight(ResourceSetting.User, UserOperator.Modify);
}
@section script
{
    <script type="text/javascript">
        var updateTable;
        seajs.use(['valid', 'user', 'tmpl', "/scripts/json2.js", "uniform"], function () {

            $(".actionCheckbox").uniform().click(function () {
                $("#BtnApply").prop("disabled", $(".actionCheckbox:checked").length == 0);
            }).click();
            $("#selApplyAction").uniform();
            $("#BtnApply").click(function () {
                var action = $("#selApplyAction").val();
                $("#tableForm").attr("action", "User/" + action).submit();
            });
            $("input[name=loginIds]").change(function () {
                var val = $("input[name=loginIds]:checked").length == 0 ? true : false;
                $("#unlockButton,#approvedButton,#delete,#Lock").attr("disabled", val);
            });

            $("#btnCreateUser").click(function () {
                $("#createUserModel form").submit();
            });

            $("#createUserModel").on("hidden", function () {
                $(this).userEditor('reset');
            }).userEditor();

            updateTable = function (user) {
                if (user.success) {
                    $("#userTableTmpl").tmpl(user).prepend($("#userListBody"));
                    $('#createUserModel').modal('hide');
                    return;
                }
            };
            $("#search :submit").click(function () {
                var searchData = {
                    loginIdOrEmail: $("#searchContent").val()
                };
                $.post("@Url.Action("Search")", searchData,
                    function (user) {
                        var target = $("#userListBody").empty();
                        if (user.length > 0) {
                            target.append($("#userTableTmpl").tmpl(user));
                        }
                        $("table").toggle(user.length > 0);
                        $("#alertMsg").toggle(user.length == 0);
                    });
            });
        });

        function GetDate(jsonDate) {
            if (jsonDate == null)
                return "";
            var value = new Date(parseInt(jsonDate.substr(6)));
            return value.getFullYear() + "-" + (value.getMonth() + 1) + "-" + value.getDate() + " " + value.getHours() + ":" + value.getMinutes() + ":" + value.getSeconds();
        }
    </script>
}
@section pageTitle{
    <h5>@String.Format("{0}{1}", MemberShip.User, "列表")</h5>
}
<div class="actions-wrapper">
    <div class="actions">

        <div id="user-stats">
            <ul class="round-buttons">
                @if (OrnamentContext.Current.HasRight("User", UserOperator.Modify))
                {
                    <li>
                        <div class="depth"><a href="#createUserModel" data-toggle="modal" title="@Html.GetResourceString("quickAction_CreateUser")" class="tip"><i class="icon-user"></i></a></div>
                    </li>
                }
                <li>
                    <div class="depth"><a href="" title="View statement" class="tip"><i class="icon-search"></i></a></div>
                </li>
                <li>
                    <div class="depth"><a href="" title="Media posts" class="tip"><i class="icon-reorder"></i></a></div>
                </li>
                <li>
                    <div class="depth"><a href="" title="RSS feed" class="tip"><i class="icon-rss"></i></a></div>
                </li>
                <li>
                    <div class="depth"><a href="" title="Create new task" class="tip"><i class="icon-tasks"></i></a></div>
                </li>
                <li>
                    <div class="depth"><a href="" title="Layout settings" class="tip"><i class="icon-cogs"></i></a></div>
                </li>

            </ul>
        </div>
        <ul class="action-tabs">
            <li><a href="#user-stats" title="">@Html.GetResourceString("QuickActions")</a></li>
        </ul>
    </div>
</div>

<form action="#" class="search widget" id="search">
    <div class="autocomplete-append">
        <input type="text" id="searchContent" placeholder="" class="ui-autocomplete-input" autocomplete="off">
        <span role="status" aria-live="polite" class="ui-helper-hidden-accessible"></span>
        <input type="submit" value="@Basic.Search" class="btn btn-info">
        <ul class="ui-autocomplete ui-menu ui-widget ui-widget-content ui-corner-all" id="searchTextBox" tabindex="0" style="z-index: 1; display: none;"></ul>
    </div>
</form>


<ul class="options-bar">
    @* @if (OrnamentContext.Current.HasRight("User", UserOperator.Modify))
    {
        <li style="width: 80px">
            <div class="bulk">
                <div class="bar-button">
                    <a id="create" href="#createUserModel" title="" data-toggle="modal" class="btn"><span>@Basic.Create</span>
                    </a>
                </div>
            </div>
        </li>
    }*@
    <li>

        <form>
            <div class="bulk">
                <div class="bar-select">
                    <span>@Html.GetResourceString("ApplyAction")</span>

                    <select id="selApplyAction">
                        @if (OrnamentContext.Current.HasRight("User", UserOperator.Lock))
                        {
                            <option value="Lock">@Html.GetResourceString("Lock")</option>
                            <option value="unLock">@Html.GetResourceString("Unlock")</option>
                        }

                        @if (OrnamentContext.Current.HasRight("User", UserOperator.Approve))
                        {
                            <option value="Approve">@Html.GetResourceString("Approve")</option>
                        }
                        @if (OrnamentContext.Current.HasRight("User", UserOperator.Delete))
                        {

                            <option value="delete">
                                @Basic.Delete
                            </option>
                        }
                    </select>

                </div>

                <div class="bar-button">
                    <button class="btn btn-info" type="button" id="BtnApply" disabled="disabled">@Html.GetResourceString("BtnApply")</button>
                </div>
            </div>
        </form>
    </li>
</ul>


<form method="POST" id="tableForm">

    <table class="table table-condensed table-striped table-bordered table-checks">
        <thead>
            <tr>
                <th></th>
                <th class="span1"></th>
                <th class="span1">
                    @Html.LabelFor(item => ((User)null).LoginId)
                </th>

                <th style="width: 100px">
                    @Html.LabelFor(item => ((User)null).Name)
                </th>
                <th>
                    @Html.LabelFor(item => ((User)null).Email)
                </th>
                <th>
                    @Html.LabelFor(item => ((User)null).IsLockout)
                </th>
                <th>
                    @Html.LabelFor(item => ((User)null).IsApproved)
                </th>
                <th>
                    @Html.LabelFor(item => ((User)null).LastActivityDate)
                </th>
            </tr>
        </thead>
        <tbody id="userListBody">

            @foreach (User user in Model)
            {
                string clz = "";
                if (user.IsApproved == false)
                {
                    clz = "class=info";
                }
                if (user.IsLockout)
                {
                    clz = "class=Warning";
                }
                <tr @clz>
                    <td>
                        <input type="checkbox" name="loginIds" value="@user.LoginId" class="actionCheckbox"/>
                    </td>
                    @if (editPermission)
                    {
                        <td>
                            <ul class="table-controls">
                                <li><a href="@Url.Action("Edit", new { id = user.LoginId })" class="btn tip" title="@Basic.Edit">
                                    <i class="fam-user-edit"></i></a></li>
                                <li>
                                    <a  href="@Url.Action("Assign", new { id = user.LoginId })" class="btn tip" title="@Html.GetResourceString("Assignment")">
                                        <i class="fam-group-gear"></i></a>
                                </li>
                            </ul>
                        </td>
                    }
                    <td>
                        @user.LoginId
                    </td>
                    <td>
                        @user.Name
                    </td>
                    <td>
                        @user.Email
                    </td>
                    <td style="text-align: center">
                        <div class="@(user.IsLockout ? "icon-ok" : "icon-remove")">
                        </div>
                    </td>
                    <td style="text-align: center">
                        <div class="@(user.IsApproved ? "icon-ok" : "icon-remove")">
                        </div>
                    </td>
                    <td>
                        @user.LastActivityDate
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="8">
                    <form id="navbar">
                        @Html.Partial("NavPagination", ViewData["Nav"])
                    </form>
                </td>
            </tr>
        </tfoot>
    </table>
</form>
<p>
    @Html.AlertMessage(Html.GetResourceString("UserNotFound"), false, new { id = "alertMsg" })
</p>

<script id="userTableTmpl" type="text/x-jquery-tmpl">
    {{if(State.IsLockout)}}
    <tr class="warning">
        {{else (State.IsApproved==false)}}
    <tr class="info">
        {{else}}
    <tr>
        {{/if}}
        <td>
            @if (OrnamentContext.Current.HasRight("User", UserOperator.Lock) || OrnamentContext.Current.HasRight("User", UserOperator.Delete) || OrnamentContext.Current.HasRight("User", UserOperator.Approve))
            {
                <input type="checkbox" name="loginIds" value="${BasicInfo.LoginId}}" class="actionCheckbox" />
            }
        </td>
        @if (editPermission)
        {
            <td>
                <ul class="table-controls">
                    <li><a href="/Memberships/User/Edit/${BasicInfo.LoginId}" class="btn tip" title="@Basic.Edit">
                        <i class="fam-user-edit"></i></a></li>
                    <li>
                        <a  href="/Memberships/User/Edit/${BasicInfo.LoginId}" class="btn tip" title="@Html.GetResourceString("Assignment")">
                            <i class="fam-group-gear"></i></a>
                    </li>
                </ul>
            </td>
        }
        <td>${BasicInfo.LoginId}
        </td>
        <td>${BasicInfo.Name}
        </td>
        <td>${BasicInfo.Email}
        </td>
        <td style="text-align: center">{{if(State.IsLockout)}}
                <div class="icon-ok"></div>
            {{else}}
                <div class="icon-remove"></div>
            {{/if}}

        </td>
        <td style="text-align: center">{{if(State.IsApproved)}}
                <div class="icon-ok"></div>
            {{else}}
                <div class="icon-remove"></div>
            {{/if}}
        </td>
        <td>${GetDate(OtherInfo.LastActivityDate)}
        </td>
    </tr>
</script>

<!-- place holder for dialog -->
@{
    var ajaxOptions = new AjaxOptions
        {
            HttpMethod = "post",
            OnSuccess = "updateTable",
        };
    var formStyle = new
        {
            @class = "form-horizontal row-fluid ",
            autocomplete = "off",
        };
}
<div id="createUserModel" class="modal hide fade" style="width: 600px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>@Basic.Create@(MemberShip.User)</h3>
    </div>
    <div class="modal-body">
        @using (Ajax.BeginForm("Create", "User", null, ajaxOptions, formStyle))
        {
            @Html.Partial("Create", new CreateUserModel())
        }
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">@Basic.Cancel</a>
        <a href="#" class="btn btn-primary" id="btnCreateUser">@Basic.Save</a>
    </div>
</div>

