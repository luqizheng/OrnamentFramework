@using Ornament.MemberShip
@using Ornament.MemberShip.Dao
@using Ornament.MemberShip.Permissions
@using Ornament.Web
@using Qi.Web
@using Resources
@model IEnumerable<Ornament.MemberShip.Role>
@{
    IList<Role> roles = OrnamentContext.Current.GetDaoFactory<IMemberShipFactory>().CreateRoleDao().GetAll();
    IOrderedQueryable<Permission> permissions = from permission in OrnamentContext.Current.GetDaoFactory<IMemberShipFactory>().Permissions
                                                orderby permission.Name
                                                select permission;

    Dictionary<string, object> mapping = roles.ToDictionary<Role, string, object>(a => a.Id, a => new List<string>(from s in a.Permissions select s.Id));


}
<style type="text/css">
    #permissionPanel ul { list-style: none; }
</style>
<script type="text/javascript">

    $(document).ready(function() {
        var mapping = @Html.Raw(JsonHelper.ToJson(mapping));
        $("#roles input").change(function() {
            var permissions = mapping[$(this).val()].join(",#");
            var tag = $("#" + permissions);
            if (this.checked) {
                tag.removeClass("icon-check-empty").addClass("icon-check");
            } else {
                tag.addClass("icon-check-empty").removeClass("icon-check");
            }

        }).change();
    });
</script>
<div class="row">
    <section class="span4">
        <header>
            <h3>@MemberShip.Role</h3>
        </header>
        <section class="form-horizontal" id="roles">
            @foreach (Role role in roles)
            {
                string checkeds = "";
                if (Model != null)
                {
                    if (Model.Any(a => a.Id == role.Id))
                    {
                        checkeds = mapping.ContainsKey(role.Id) ? "checked=\"checked\"" : "";
                    }
                }
                <label for="@role.Id">
                    <input name="roles" id="@role.Id" type="checkbox" value="@role.Id"  @Html.Raw(checkeds)/>
                    @role.Name
                </label>
            }
        </section>
    </section>
    <section class="span4 offset1 well" id="permissionPanel">
        <header>
            <h3>@MemberShip.Permission</h3>
        </header>
        <section>
            <ul>
                @foreach (Permission permission in permissions)
                {
                    <li><i id="@permission.Id" class="icon-check-empty"></i>@permission.Name
                    </li>
                }
            </ul>
        </section>
    </section>
</div>